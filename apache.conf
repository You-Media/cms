# Optimized Apache configuration for static Next.js export
ServerName localhost

# Log configuration
LogLevel warn
ErrorLog /proc/self/fd/2
CustomLog /proc/self/fd/1 combined

# Listen on port 80
Listen 80

# Load MPM (Multi-Processing Module) - REQUIRED
LoadModule mpm_event_module modules/mod_mpm_event.so

# Core modules
LoadModule mime_module modules/mod_mime.so
LoadModule headers_module modules/mod_headers.so
LoadModule deflate_module modules/mod_deflate.so
LoadModule expires_module modules/mod_expires.so
LoadModule rewrite_module modules/mod_rewrite.so
LoadModule negotiation_module modules/mod_negotiation.so
LoadModule authz_core_module modules/mod_authz_core.so
LoadModule filter_module modules/mod_filter.so
LoadModule dir_module modules/mod_dir.so
LoadModule log_config_module modules/mod_log_config.so
LoadModule unixd_module modules/mod_unixd.so

# MPM Configuration
<IfModule mpm_event_module>
    ServerLimit             8
    StartServers           2
    MinSpareThreads        10
    MaxSpareThreads        20
    ThreadLimit           64
    ThreadsPerChild       25
    MaxRequestWorkers     200
    MaxConnectionsPerChild 0
</IfModule>

# Document root and directory access
DocumentRoot "/usr/local/apache2/htdocs"
<Directory "/usr/local/apache2/htdocs">
    Options FollowSymLinks
    AllowOverride None
    Require all granted
</Directory>

# Gzip compression (fallback when no precompressed asset is available)
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/plain text/html text/xml text/css application/xml application/xhtml+xml application/rss+xml application/javascript application/x-javascript application/json image/svg+xml
</IfModule>

# Serve precompressed (.br/.gz) versions when available
#  - Produciamo i file .br/.gz nel build
#  - Reindirizziamo verso le versioni compresse in base ad Accept-Encoding
#  - Impostiamo i MIME type corretti per le estensioni compresse
AddEncoding br .br
AddEncoding gzip .gz

# Map MIME types for compressed variants
AddType text/css .css.br
AddType application/javascript .js.br
AddType application/json .json.br
AddType image/svg+xml .svg.br
AddType text/html .html.br
AddType text/plain .txt.br

AddType text/css .css.gz
AddType application/javascript .js.gz
AddType application/json .json.gz
AddType image/svg+xml .svg.gz
AddType text/html .html.gz
AddType text/plain .txt.gz

# Vary header for content negotiation
<IfModule mod_headers.c>
    Header append Vary Accept-Encoding
</IfModule>

<IfModule mod_rewrite.c>
    RewriteEngine On
    # Prefer Brotli
    RewriteCond %{HTTP:Accept-Encoding} br
    RewriteCond %{REQUEST_FILENAME}.br -f
    RewriteRule ^(.+)$ $1.br [L]
    # Otherwise try gzip
    RewriteCond %{HTTP:Accept-Encoding} gzip
    RewriteCond %{REQUEST_FILENAME}.gz -f
    RewriteRule ^(.+)$ $1.gz [L]
</IfModule>

# Browser caching
<IfModule mod_expires.c>
    ExpiresActive On
    # Long cache for hashed assets
    <LocationMatch "^/_next/|\.(?:css|js|svg|png|jpg|jpeg|gif)$">
        ExpiresDefault "access plus 1 year"
    </LocationMatch>
    # HTML short cache
    <FilesMatch "\.(?:html)$">
        ExpiresDefault "access plus 1 hour"
    </FilesMatch>
</IfModule>

# Cache-Control headers (immutable for Next hashed assets)
<IfModule mod_headers.c>
    <LocationMatch "^/_next/">
        Header set Cache-Control "public, max-age=31536000, immutable"
    </LocationMatch>
    <FilesMatch "\.(?:css|js|svg|png|jpg|jpeg|gif)$">
        Header set Cache-Control "public, max-age=31536000"
    </FilesMatch>
    <FilesMatch "\.(?:html)$">
        Header set Cache-Control "public, max-age=3600"
    </FilesMatch>
    # Security headers
    Header always set X-Content-Type-Options nosniff
    Header always set X-Frame-Options DENY
    Header always set X-XSS-Protection "1; mode=block"
</IfModule>

DirectoryIndex index.html
